name: Daily RepoSync

on:
  schedule:
    # Runs at 8:00 AM UTC every day
    - cron: '0 8 * * *'
  workflow_dispatch:  # Allows manual triggering

jobs:
  sync:
    name: Execute RepoSync Workflow
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Verify Java version
        run: |
          echo "JAVA_HOME: $JAVA_HOME"
          java -version
          mvn -version

      - name: Build all services
        run: mvn clean package -DskipTests -Dcheckstyle.failOnViolation=false

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Set up environment variables
        run: |
          echo "REPOSYNC_GITHUB_TOKEN=${{ secrets.REPOSYNC_GITHUB_TOKEN }}" >> $GITHUB_ENV
          echo "REPOSYNC_ORGANIZATION=${{ secrets.REPOSYNC_ORGANIZATION }}" >> $GITHUB_ENV
          echo "REPOSYNC_FILTER_KEYWORD=${{ secrets.REPOSYNC_FILTER_KEYWORD }}" >> $GITHUB_ENV
          echo "AZURE_OPENAI_API_KEY=${{ secrets.AZURE_OPENAI_API_KEY }}" >> $GITHUB_ENV
          echo "AZURE_OPENAI_ENDPOINT=${{ secrets.AZURE_OPENAI_ENDPOINT }}" >> $GITHUB_ENV
          echo "AZURE_OPENAI_EMBEDDINGS_DEPLOYMENT=${{ secrets.AZURE_OPENAI_EMBEDDINGS_DEPLOYMENT }}" >> $GITHUB_ENV
          echo "MILVUS_URI=${{ secrets.MILVUS_URI }}" >> $GITHUB_ENV
          if [ -n "${{ secrets.MILVUS_TOKEN }}" ]; then
            echo "MILVUS_TOKEN=${{ secrets.MILVUS_TOKEN }}" >> $GITHUB_ENV
          fi
          echo "MILVUS_COLLECTION_NAME=${{ secrets.MILVUS_COLLECTION_NAME }}" >> $GITHUB_ENV

      - name: Start GitHub Service
        env:
          GITHUB_TOKEN: ${{ secrets.REPOSYNC_GITHUB_TOKEN }}
        run: |
          cd github-service
          nohup java \
            -Dgithub.token="$GITHUB_TOKEN" \
            -Dserver.port=8081 \
            -jar target/*.jar > github-service.log 2>&1 &
          echo $! > github-service.pid
          sleep 30

      - name: Verify GitHub Service Health
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:8081/actuator/health > /dev/null 2>&1; then
              echo "GitHub Service is healthy"
              exit 0
            fi
            echo "Waiting for GitHub Service to be ready... ($i/30)"
            sleep 2
          done
          echo "GitHub Service failed to start"
          cat github-service/github-service.log
          exit 1

      - name: Start Document Processor Service
        run: |
          cd document-processor-service
          nohup java \
            -Dserver.port=8082 \
            -jar target/*.jar > processor-service.log 2>&1 &
          echo $! > processor-service.pid
          sleep 20

      - name: Verify Document Processor Service Health
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:8082/actuator/health > /dev/null 2>&1; then
              echo "Document Processor Service is healthy"
              exit 0
            fi
            echo "Waiting for Document Processor Service to be ready... ($i/30)"
            sleep 2
          done
          echo "Document Processor Service failed to start"
          cat document-processor-service/processor-service.log
          exit 1

      - name: Start Embedding Service
        env:
          API_KEY: ${{ secrets.AZURE_OPENAI_API_KEY }}
          ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          DEPLOYMENT: ${{ secrets.AZURE_OPENAI_EMBEDDINGS_DEPLOYMENT }}
        run: |
          cd embedding-service
          nohup java \
            -Dazure.openai.api-key="$API_KEY" \
            -Dazure.openai.endpoint="$ENDPOINT" \
            -Dazure.openai.embeddings-deployment="$DEPLOYMENT" \
            -Dserver.port=8083 \
            -jar target/*.jar > embedding-service.log 2>&1 &
          echo $! > embedding-service.pid
          sleep 30

      - name: Verify Embedding Service Health
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:8083/actuator/health > /dev/null 2>&1; then
              echo "Embedding Service is healthy"
              exit 0
            fi
            echo "Waiting for Embedding Service to be ready... ($i/30)"
            sleep 2
          done
          echo "Embedding Service failed to start"
          cat embedding-service/embedding-service.log
          exit 1

      - name: Debug Secrets (Masked)
        run: |
          echo "Checking if secrets exist..."
          if [ -z "${{ secrets.MILVUS_URI }}" ]; then
            echo "‚ùå CRITICAL ERROR: MILVUS_URI secret is EMPTY or NOT FOUND!"
            echo "Please go to: Repository Settings -> Secrets and variables -> Actions"
            echo "And verify that MILVUS_URI is properly configured."
            exit 1
          else
            echo "‚úÖ MILVUS_URI is set (Length: ${#MILVUS_URI})"
          fi
          
          if [ -z "${{ secrets.MILVUS_COLLECTION_NAME }}" ]; then
            echo "‚ö†Ô∏è  WARNING: MILVUS_COLLECTION_NAME secret is EMPTY - will use default 'reposync_collection'"
          else
            echo "‚úÖ MILVUS_COLLECTION_NAME is set (Length: ${#COLLECTION})"
          fi
          
          if [ -z "${{ secrets.MILVUS_TOKEN }}" ]; then
            echo "‚ÑπÔ∏è  INFO: MILVUS_TOKEN is not set (this may be optional)"
          else
            echo "‚úÖ MILVUS_TOKEN is set"
          fi
        env:
          MILVUS_URI: ${{ secrets.MILVUS_URI }}
          COLLECTION: ${{ secrets.MILVUS_COLLECTION_NAME }}

      - name: Start Milvus Service
        env:
          # Check if secrets exist before starting
          URI_CHECK: ${{ secrets.MILVUS_URI }}

          # Inject configuration via JSON (Safest method - bypasses shell quoting issues)
          SPRING_APPLICATION_JSON: >-
            {
              "milvus": {
                "uri": "${{ secrets.MILVUS_URI }}",
                "token": "${{ secrets.MILVUS_TOKEN }}",
                "collection-name": "${{ secrets.MILVUS_COLLECTION_NAME }}"
              },
              "server": {
                "port": 8084
              }
            }
        run: |
          # 1. Debugging: Fail fast if secrets are missing
          if [ -z "$URI_CHECK" ]; then
            echo "‚ùå ERROR: MILVUS_URI secret is empty! Go to GitHub Repo Settings -> Secrets to fix this."
            exit 1
          fi
          
          echo "‚úÖ MILVUS_URI is found. Starting service..."
          
          cd milvus-service
          nohup java -jar target/*.jar > milvus-service.log 2>&1 &
          echo $! > milvus-service.pid
          sleep 30

      - name: Verify Milvus Service Health
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:8084/actuator/health > /dev/null 2>&1; then
              echo "Milvus Service is healthy"
              exit 0
            fi
            echo "Waiting for Milvus Service to be ready... ($i/30)"
            sleep 2
          done
          echo "Milvus Service failed to start"
          cat milvus-service/milvus-service.log
          exit 1

      - name: Start Orchestrator Service and Execute Sync
        env:
          # Inject configuration via JSON (Safest method)
          SPRING_APPLICATION_JSON: >-
            {
              "milvus": {
                "uri": "${{ secrets.MILVUS_URI }}",
                "token": "${{ secrets.MILVUS_TOKEN }}",
                "collection-name": "${{ secrets.MILVUS_COLLECTION_NAME }}"
              },
              "reposync": {
                "organization": "${{ secrets.REPOSYNC_ORGANIZATION }}",
                "filter-keyword": "${{ secrets.REPOSYNC_FILTER_KEYWORD }}"
              },
              "services": {
                "github": {
                  "url": "http://localhost:8081"
                },
                "processor": {
                  "url": "http://localhost:8082"
                },
                "embedding": {
                  "url": "http://localhost:8083"
                },
                "milvus": {
                  "url": "http://localhost:8084"
                }
              },
              "server": {
                "port": 8080
              }
            }
        run: |
          echo "‚úÖ Starting Orchestrator Service with JSON configuration..."
          
          cd orchestrator-service
          nohup java -jar target/*.jar > orchestrator-service.log 2>&1 &
          echo $! > orchestrator-service.pid
          sleep 60

      - name: Verify Orchestrator Service Health
        run: |
          for i in {1..30}; do
            if curl -f http://localhost:8080/actuator/health > /dev/null 2>&1; then
              echo "Orchestrator Service is healthy"
              exit 0
            fi
            echo "Waiting for Orchestrator Service to be ready... ($i/30)"
            sleep 2
          done
          echo "Orchestrator Service failed to start"
          cat orchestrator-service/orchestrator-service.log
          exit 1

      - name: Verify All Services Connectivity
        run: |
          echo "=== Checking All Services ==="
          
          echo "1. GitHub Service (8081):"
          curl -f http://localhost:8081/actuator/health || echo "‚ùå Failed"
          
          echo "2. Document Processor Service (8082):"
          curl -f http://localhost:8082/actuator/health || echo "‚ùå Failed"
          
          echo "3. Embedding Service (8083):"
          curl -f http://localhost:8083/actuator/health || echo "‚ùå Failed"
          
          echo "4. Milvus Service (8084):"
          curl -f http://localhost:8084/actuator/health || echo "‚ùå Failed"
          
          echo "5. Orchestrator Service (8080):"
          curl -f http://localhost:8080/actuator/health || echo "‚ùå Failed"
          
          echo "=== All services checked ==="

      - name: Trigger Sync Job
        run: |
          sleep 10
          echo "Triggering sync job..."
          HTTP_CODE=$(curl -s -w "%{http_code}" -X POST http://localhost:8080/api/orchestrator/sync \
            -H "Content-Type: application/json" \
            -o sync-result.json)
          
          echo "HTTP Response Code: $HTTP_CODE"
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "Error: Sync API returned HTTP $HTTP_CODE"
            echo "Response body:"
            cat sync-result.json || echo "No response body"
            echo ""
            echo "=== Orchestrator Service Logs ==="
            tail -200 orchestrator-service/orchestrator-service.log || echo "No logs available"
            exit 1
          fi
          
          echo "Sync job response:"
          cat sync-result.json
          
          # Give the sync job time to complete
          echo "Waiting for sync to complete..."
          sleep 60

      - name: Check Sync Status
        run: |
          if [ ! -f sync-result.json ]; then
            echo "Error: sync-result.json not found"
            exit 1
          fi
          
          # 1. Always print the raw JSON first so we see the error message
          echo "=== Sync Result JSON ==="
          cat sync-result.json
          echo "========================"
          echo ""
          
          # 2. Extract fields
          STATUS=$(jq -r '.status' sync-result.json)
          ERROR_MSG=$(jq -r '.errorMessage' sync-result.json)
          
          # 3. Check Status
          if [ "$STATUS" != "SUCCESS" ]; then
            echo "‚ùå Sync Logic Failed!"
            echo "Status: $STATUS"
            echo "Reason: $ERROR_MSG"
            
            echo ""
            echo "=== Tailing Service Logs for Debugging ==="
            # Print the last 150 lines of the Orchestrator log specifically
            # because that is where the Java Exception stack trace lives.
            echo "--- Orchestrator Logs (last 150 lines) ---"
            tail -n 150 orchestrator-service/orchestrator-service.log
            
            echo ""
            echo "--- GitHub Service Logs (last 50 lines) ---"
            tail -n 50 github-service/github-service.log || echo "No github service logs"
            
            echo ""
            echo "--- Embedding Service Logs (last 50 lines) ---"
            tail -n 50 embedding-service/embedding-service.log || echo "No embedding service logs"
            
            echo ""
            echo "--- Milvus Service Logs (last 50 lines) ---"
            tail -n 50 milvus-service/milvus-service.log || echo "No milvus service logs"
            
            # Fail the build
            exit 1
          fi
          
          # 4. Success case - show statistics
          REPOS=$(jq -r '.repositoriesProcessed // 0' sync-result.json)
          DOCS=$(jq -r '.documentsProcessed // 0' sync-result.json)
          CHUNKS=$(jq -r '.chunksCreated // 0' sync-result.json)
          VECTORS=$(jq -r '.vectorsStored // 0' sync-result.json)
          
          echo "‚úÖ Sync Success!"
          echo "üìä Statistics:"
          echo "  ‚Ä¢ Repositories processed: $REPOS"
          echo "  ‚Ä¢ Documents processed: $DOCS"
          echo "  ‚Ä¢ Chunks created: $CHUNKS"
          echo "  ‚Ä¢ Vectors stored: $VECTORS"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: service-logs
          path: |
            *-service/*.log
            sync-result.json

      - name: Cleanup
        if: always()
        run: |
          for service in github-service document-processor-service embedding-service milvus-service orchestrator-service; do
            if [ -f $service/$service.pid ]; then
              kill $(cat $service/$service.pid) || true
            fi
          done

